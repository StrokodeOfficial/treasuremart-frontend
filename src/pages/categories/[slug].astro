---
export const prerender = false;

import BaseLayout from '@layouts/BaseLayout.astro';
import ProductCard from '@components/ProductCard.astro';
import client, { fetchProducts, urlFor } from '../../lib/sanity';

const slug = Astro.params.slug;

// Fetch the category by slug (works for both parent and child categories)
const category = await client.fetch(
    `*[_type == "category" && (slug.current == $slug || slug == $slug)][0]{_id,title,slug,description,cover}`,
    { slug }
);

let products = [];
if (category) {
    const prods = await fetchProducts(`&& references("${category._id}")`);
    products = prods.map((p) => ({
        _id: p._id,
        title: p.title,
        slug: p.slug && p.slug.current ? p.slug.current : p.slug,
        price: p.price,
        mrp: p.mrp || null,
        imageUrl: p.images && p.images[0] ? urlFor(p.images[0]).auto('format').width(800).url() : '/placeholder.png',
        categorySlug:
            (p.categories && p.categories.length && p.categories[0].slug && p.categories[0].slug.current) || 'misc',
    }));
}

---

<BaseLayout>
    <main class="max-w-7xl mx-auto px-4 py-12">
        {category ? (
            <section class="space-y-6">
                <div class="bg-white rounded-xl shadow overflow-hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center p-6">
                        <div class="md:col-span-2">
                            <h1 class="text-3xl font-extrabold">{category.title}</h1>
                            <p class="text-slate-600 mt-2">{category.description}</p>
                        </div>
                        {category.cover ? (
                            <img src={urlFor(category.cover).auto('format').width(1200).url()} alt={category.title} class="w-full h-40 object-cover rounded-md" />
                        ) : (
                            <div class="w-full h-40 bg-slate-100 rounded-md" />
                        )}
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-semibold mb-4">Products in {category.title}</h2>
                    {products.length === 0 ? (
                        <div class="bg-white rounded-xl p-8 text-center text-slate-500">No products found in this category.</div>
                    ) : (
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            {products.map((p) => (
                                <ProductCard product={p} />
                            ))}
                        </div>
                    )}
                </div>
            </section>
        ) : (
            <section class="text-center py-20">
                <h1 class="text-2xl font-bold">Category not found</h1>
                <p class="text-slate-600 mt-2">We couldn't find the category you're looking for.</p>
            </section>
        )}
    </main>
</BaseLayout>
