---
import BaseLayout from "../layouts/BaseLayout.astro";
import ProductCard from "../components/ProductCard.astro";
import CategoryCard from "../components/CategoryCard.astro";
import { fetchCategories, fetchProducts, urlFor } from "../lib/sanity";

// Fetch top-level categories and featured products
const categories = await fetchCategories();
const allProducts: any[] = await fetchProducts();

// Map products into the shape expected by ProductCard component
const featured = allProducts.slice(0, 12).map((p) => ({
  _id: p._id,
  title: p.title,
  slug: p.slug.current || p.slug,
  price: p.price,
  mrp: p.mrp || null,
  imageUrl: p.images && p.images[0] ? urlFor(p.images[0]).auto("format").width(800).url() : '/placeholder.png',
  categorySlug:
    (p.categories && p.categories.length && p.categories[0].slug && p.categories[0].slug.current) || 'misc',
}));

// Convert categories for CategoryCard
const categoryCards = categories.map((c) => ({
  _id: c._id,
  title: c.title,
  slug: c.slug.current || c.slug,
  coverUrl: c.cover ? urlFor(c.cover).auto("format").width(1600).url() : '/category-placeholder.jpg',
  description: c.description || '',
}));
---

<BaseLayout>
  <main class="max-w-7xl mx-auto px-4 py-12 space-y-12">
    <!-- Hero -->
    <section class="relative bg-gradient-to-br from-purple-600 to-indigo-600 rounded-2xl overflow-hidden shadow-xl">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center p-8 md:p-12">
        <div class="text-white">
          <h1 class="text-4xl md:text-5xl font-extrabold leading-tight mb-4">Discover great deals on everyday finds</h1>
          <p class="text-lg opacity-90 mb-6">Curated products across categories — quality you can trust at prices you’ll love.</p>
          <div class="flex gap-3">
            <a href="/products" class="inline-block bg-white text-purple-700 font-semibold px-5 py-3 rounded-lg shadow hover:shadow-md">Shop Now</a>
            <a href="/categories" class="inline-block border border-white/30 text-white px-5 py-3 rounded-lg hover:bg-white/10">Browse Categories</a>
          </div>
        </div>
        <div class="hidden md:block">
          <img src="/hero-image.jpg" alt="Hero illustration" class="w-full h-72 object-cover rounded-lg shadow-lg" />
        </div>
      </div>
    </section>

    <!-- Promo strip -->
    <section class="bg-white rounded-lg shadow-sm p-4 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="flex items-center justify-center w-12 h-12 bg-[rgba(79,70,229,0.1)] rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h3.5a1 1 0 010 2H4v10h12V5h-3.5a1 1 0 110-2H16a2 2 0 012 2v11a1 1 0 01-1 1H3a1 1 0 01-1-1V5z"/></svg>
        </div>
        <div>
          <p class="font-semibold">Free shipping over ₹999</p>
          <p class="text-sm text-slate-500">Fast delivery across India — returns within 7 days.</p>
        </div>
      </div>
      <a href="/checkout" class="text-sm text-purple-600 font-semibold hover:underline">Checkout offers →</a>
    </section>

    <!-- Categories Grid -->
    <section>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold">Shop by category</h2>
        <a href="/categories" class="text-sm text-indigo-600 hover:underline">See all</a>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {categoryCards.map((cat) => (
          <CategoryCard category={cat} />
        ))}
      </div>
    </section>

    <!-- Featured Products -->
    <section>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-bold">Featured products</h2>
        <a href="/products" class="text-sm text-indigo-600 hover:underline">View all</a>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {featured.map((p) => (
          <ProductCard product={p} />
        ))}
      </div>
    </section>

    <!-- Newsletter -->
    <section class="bg-gradient-to-r from-slate-900 to-slate-800 text-white rounded-lg p-6 md:p-10">
      <div class="max-w-3xl mx-auto text-center">
        <h3 class="text-2xl font-bold mb-2">Join our newsletter</h3>
        <p class="opacity-90 mb-4">Get exclusive discounts, new arrivals, and product picks — directly in your inbox.</p>
        <form class="flex flex-col sm:flex-row gap-3 justify-center">
          <input type="email" placeholder="Your email" class="w-full sm:w-auto min-w-[320px] px-4 py-3 rounded-md text-slate-800" />
          <button class="px-6 py-3 bg-indigo-600 rounded-md font-semibold hover:bg-indigo-700">Subscribe</button>
        </form>
      </div>
    </section>
  </main>
</BaseLayout>

