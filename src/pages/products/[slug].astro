---
export const prerender = false;

import BaseLayout from '@layouts/BaseLayout.astro';
import ProductCard from '@components/ProductCard.astro';
import { fetchProducts, urlFor } from '../../lib/sanity';

// Small helper to parse cookie header to detect a minimal user object (non-blocking)
function getUserFromCookies(cookieHeader) {
    if (!cookieHeader) return null;
    try {
        const cookies = Object.fromEntries(cookieHeader.split(';').map(s => s.split('=').map(p => p && p.trim())));
        // Example: if you store 'user' cookie as JSON base64 or id, adapt here. For now, return a truthy placeholder.
        if (cookies.user) return { id: cookies.user };
    } catch (e) { /* ignore */ }
    return null;
}

const user = getUserFromCookies(Astro.request.headers.get('cookie'));

// Fetch the product matching the route slug from Sanity
const slug = Astro.params.slug;
const results = await fetchProducts(`&& slug.current == "${slug}"`);
const product = results && results[0] ? results[0] : null;

// Build gallery safely
const gallery = (product && Array.isArray(product.images))
    ? product.images.map(img => {
            try {
                if (!img) return '/placeholder.jpg';
                if (typeof img === 'string') return img;
                return urlFor(img).height(1200).auto('format').url();
            } catch (e) {
                return '/placeholder.jpg';
            }
        })
    : [];

const price = product && product.price != null ? Number(product.price) : null;
const mrp = product && product.mrp != null ? Number(product.mrp) : null;
const isCouple = product && Array.isArray(product.tags) && product.tags.some(t => (t.slug && t.slug.current === 'couple') || t === 'couple');
const fmt = (n) => (n == null ? '' : `â‚¹${Number(n).toLocaleString('en-IN')}`);
const availableSizes = (product && Array.isArray(product.variants))
    ? product.variants.filter(v => v.inStock && v.stock > 0).map(v => v.size)
    : [];
const tags = product && product.categories ? product.categories : [];
const discountPercent = (mrp && price) ? Math.round(((mrp - price) / mrp) * 100) : 0;

// Build a plain-text / HTML description renderer. Try to dynamically import @portabletext/react if available.
let PortableTextComp = null;
try {
    // dynamic import; will fail if package not installed, we'll fall back
    // Note: dynamic import works in frontmatter because it's top-level await context
    const mod = await import('@portabletext/react');
    PortableTextComp = mod.PortableText || mod.default || null;
} catch (e) {
    PortableTextComp = null;
}

function portableTextToPlain(pt) {
    if (!pt) return '';
    if (typeof pt === 'string') return pt;
    try {
        return pt.map(blk => (blk.children || []).map(c => c.text || '').join(' ')).filter(Boolean).join('\n\n');
    } catch (e) { return ''; }
}

const plainDescription = portableTextToPlain(product && product.description ? product.description : '') || product?.excerpt || product?.title || '';

// JSON-LD product schema
const priceValue = price != null ? Number(price) : null;
const availability = (product && Array.isArray(product.variants) && product.variants.some(v => v.inStock && v.stock > 0)) ? 'https://schema.org/InStock' : 'https://schema.org/OutOfStock';
const sku = product?.sku || product?._id || product?.slug?.current || null;
const productJsonLd = {
    '@context': 'https://schema.org/',
    '@type': 'Product',
    name: product?.title,
    image: (product?.images || []).map(i => {
        try { return urlFor(i).width(1200).auto('format').url(); } catch { return null; }
    }).filter(Boolean),
    description: plainDescription,
    sku,
    offers: priceValue ? {
        '@type': 'Offer',
        url: `https://www.mcutfactory.com/products/${product?.slug?.current || slug}`,
        priceCurrency: 'INR',
        price: String(priceValue),
        availability,
    } : undefined,
};
---

<BaseLayout>
    <article class="grid grid-cols-1 lg:grid-cols-2 gap-12 bg-white p-8 rounded-xl shadow-2xl">
    
    <div class="space-y-4">
                <!-- Gallery thumbnails + main image -->
                {gallery.length > 0 ? (
                    <>
                        <img id="main-img" src={gallery[0]} alt={product?.title || 'Product image'} class="w-full h-auto object-contain rounded-lg shadow-xl" />
                        <div class="flex space-x-2 overflow-x-auto mt-3">
                            {gallery.map((img, i) => (
                                <button type="button" data-full={img} data-index={i} class:list={["group relative rounded-md overflow-hidden", { 'ring-2 ring-black': i === 0 }]}>
                                    <img src={img} alt={`${product?.title || 'thumb'} ${i + 1}`} class="w-20 h-20 object-cover" />
                                </button>
                            ))}
                        </div>
                    </>
                ) : (
                    <img src="/placeholder.jpg" alt="placeholder" class="w-full h-auto object-contain rounded-lg shadow-xl" />
                )}
    </div>

    <div>
                {product ? (
                    <>
                        <h1 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">{product.title}</h1>
                        <div class="mt-4 flex items-baseline gap-3">
                            <span class="text-3xl font-bold text-black">{fmt(price)}</span>
                            {mrp && mrp > price && (<span class="text-xl text-gray-500 line-through">{fmt(mrp)}</span>)}
                        </div>

                        <div class="mt-6">
                            <div class="prose prose-sm mt-4 text-gray-600">
                                {PortableTextComp ? (
                                    <PortableTextComp value={product.description} />
                                ) : (
                                    <div set:html={plainDescription ? plainDescription.replace(/\n/g, '<br/>') : '<p>No description available.</p>'}></div>
                                )}
                            </div>
                        </div>

                        <div class="mt-6 flex gap-4">
                            <button id="add-to-cart-btn" data-id={product._id} data-title={product.title} data-price={price ?? 0} data-slug={slug} data-image={(gallery[0]||'/placeholder.jpg')} class="flex flex-1 items-center justify-center rounded-md bg-black px-8 py-3 text-base font-semibold text-white shadow-sm transition hover:bg-gray-800" aria-disabled={!(availableSizes.length>0)}>
                                {availableSizes.length > 0 ? 'Add to Cart' : 'Out of Stock'}
                            </button>
                            <a href="/cart" class="py-3 px-6 border border-gray-300 text-lg font-medium rounded-lg shadow-md text-gray-700 bg-white hover:bg-gray-50 transition">View Cart</a>
                        </div>
                    </>
                ) : (
                    <div class="bg-white rounded-xl p-8 text-center text-slate-600">Product not found.</div>
                )}
    </div>
  </article>

  <section class="mt-12">
    <h2 class="text-3xl font-bold text-gray-900 mb-6">You might also like...</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <ProductCard product={{ _id: 'r1', title: 'Related Item 1', slug: 'related-1', price: 15.00, mrp: null, imageUrl: 'https://picsum.photos/id/1/300/400', categorySlug: 'related' }} />
        <ProductCard product={{ _id: 'r2', title: 'Related Item 2', slug: 'related-2', price: 55.00, mrp: 65.00, imageUrl: 'https://picsum.photos/id/5/300/400', categorySlug: 'related' }} />
    </div>
  </section>
</BaseLayout>

<script>
  // Script copy-pasted from ProductCard to ensure the button works here
  document.addEventListener('astro:page-load', () => {
    document.querySelectorAll('.add-to-cart-btn').forEach(button => {
        button.addEventListener('click', (event) => {
            const btn = event.currentTarget;
            const productId = btn.dataset.productId;
            const title = btn.dataset.productTitle;
            const price = parseFloat(btn.dataset.productPrice);
            const imageUrl = btn.dataset.productImage;
            
            let cart = JSON.parse(sessionStorage.getItem('cart') || '[]');
            const existingItemIndex = cart.findIndex(item => item._id === productId);

            if (existingItemIndex > -1) {
                cart[existingItemIndex].quantity += 1;
            } else {
                cart.push({
                    _id: productId,
                    title: title,
                    price: price,
                    imageUrl: imageUrl,
                    quantity: 1,
                });
            }

            sessionStorage.setItem('cart', JSON.stringify(cart));
            alert(`Added ${title} to cart!`);
            window.dispatchEvent(new Event('cartUpdated'));
        });
    });
  });
</script>