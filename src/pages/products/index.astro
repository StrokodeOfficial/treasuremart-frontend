---
import BaseLayout from '@/layouts/BaseLayout.astro';
import ShopProductCard from '@/components/ProductCard.astro';
import FilterSidebar from '@/components/FilterSidebar.astro';
import client, { fetchProducts, fetchCategories, urlFor } from '@/lib/sanity';
import type { AstroSeoProps } from '@astrolib/seo';

const url = new URL(Astro.request.url);
const catParam = url.searchParams.get('cat')?.toLowerCase() || null;
const sort = url.searchParams.get('sort') || 'newest';
const minQ = url.searchParams.get('min');
const maxQ = url.searchParams.get('max');
const instockOnly = url.searchParams.get('instock') === '1';
const pageQ = Number(url.searchParams.get('page') || '1');
const perPage = Number(url.searchParams.get('perPage') || '12');
const start = (pageQ - 1) * perPage;
const end = start + perPage - 1;

const catsRaw = await fetchCategories();
const allCategories = catsRaw.map((c: any) => ({ title: c.title, slug: (c.slug && c.slug.current ? c.slug.current : c.slug) })).sort((a: any, b: any) => a.title.localeCompare(b.title));
const validCat = allCategories.find((c: any) => c.slug === catParam);
const categoryFilter = validCat ? ` && references(*[_type=="category" && slug.current=="${validCat.slug}"][0]._id)` : '';

const allProductsData = await client.fetch(`*[_type=="product" && (!defined(status) || status=="active")] { price }`);
const allPrices = allProductsData.map((p: any) => Number(p.price ?? 0)).filter((n: number) => !Number.isNaN(n));
const minPrice = allPrices.length > 0 ? Math.min(...allPrices) : 0;
const maxPrice = allPrices.length > 0 ? Math.max(...allPrices) : 1000;
const minVal = Number.isFinite(Number(minQ)) ? Number(minQ) : minPrice;
const maxVal = Number.isFinite(Number(maxQ)) ? Number(maxQ) : maxPrice;

let groqFilter = `*[_type=="product" && (!defined(status) || status=="active")${categoryFilter}`;
if (minQ) groqFilter += ` && price >= ${minQ}`;
if (maxQ) groqFilter += ` && price <= ${maxQ}`;
if (instockOnly) groqFilter += ` && count(variants[inStock && stock > 0]) > 0`;
groqFilter += ']';

let sortOrder = '_createdAt desc';
switch (sort) {
  case 'price-asc': sortOrder = 'price asc'; break;
  case 'price-desc': sortOrder = 'price desc'; break;
  case 'name-asc': sortOrder = 'title asc'; break;
  case 'name-desc': sortOrder = 'title desc'; break;
}

const totalItems = await client.fetch(`count(${groqFilter})`);
const totalPages = Math.max(1, Math.ceil(totalItems / perPage));
const page = Math.min(Math.max(pageQ, 1), totalPages);

const pageItems = await client.fetch(`
  ${groqFilter} | order(${sortOrder}) [${start}..${end}]{
    _id, title, "slug": slug.current, "images": images[]{asset}, price, mrp,
    variants[]{ size, stock, inStock, sku },
    categories[]->{title,"slug":slug.current}
  }
`) ?? [];

function hrefWith(params: Record<string, string | null | undefined>) {
  const sp = new URLSearchParams(url.searchParams);
  for (const [k, v] of Object.entries(params)) {
    if (!v || v === '1') sp.delete(k);
    else sp.set(k, String(v));
  }
  if (Object.keys(params).some(k => k !== 'page')) {
    sp.set('page', '1');
  }
  return `/products?${sp.toString()}`;
}
function pageHref(n: number) {
  const sp = new URLSearchParams(url.searchParams);
  sp.set('page', String(n));
  return `/products?${sp.toString()}`;
}

const firstImageUrl = pageItems[0]?.images?.[0]?.asset ? urlFor(pageItems[0].images[0].asset).width(1200).auto('format').url() : '/placeholder.jpg';
const seo: AstroSeoProps = {
  title: validCat ? `${validCat.title} | Treasure Mart` : 'Products | Treasure Mart',
  description: validCat ? `Browse ${validCat.title} at Treasure Mart.` : 'Browse products at Treasure Mart.',
  canonical: `https://treasuremartonline.com/products${validCat ? `?cat=${validCat.slug}` : ''}`,
  openGraph: {
    url: `https://treasuremartonline.com/products${validCat ? `?cat=${validCat.slug}` : ''}`,
    title: validCat ? `${validCat.title} | Treasure Mart` : 'Products | Treasure Mart',
    description: validCat ? `Browse ${validCat.title} at Treasure Mart.` : 'Browse products at Treasure Mart.',
    images: [{ url: firstImageUrl, alt: validCat ? validCat.title : 'Products' }],
  },
};
---

<BaseLayout seo={seo}>
  <!-- Header -->
  <div class="border-b border-gray-200 bg-white">
    <div class="mx-auto px-4 py-4 sm:px-4 lg:px-8">
      <div class="flex items-center justify-between gap-6 ">
        <div class="lg:flex hidden md:flex-row w-full flex-col gap-4">
          <h1 class="text-3xl font-bold tracking-tight text-gray-900">{validCat ? validCat.title : 'All Products'}</h1>
          <p class="mt-2 text-base text-gray-500">{totalItems} items found</p>
        </div>
        <div class="flex flex-row w-full md:flex-col items-center gap-4">
          <button type="button" id="open-filter-btn" class="inline-flex ml-0 mr-auto md:ml-auto md:mr items-center gap-2 rounded-md border bg-white p-2 text-sm font-medium text-gray-700 hover:bg-gray-50 lg:hidden">
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h18M7 12h10M11 20h2"></path></svg>
            <span>Filters</span>
          </button>
          <form method="GET" action="/products" class="flex items-center gap-2">
             <input type="hidden" name="cat" value={catParam || ''} />
             <label for="sort" class="text-sm font-medium text-gray-700">Sort:</label>
             <select name="sort" id="sort" class="rounded-md border-gray-300 text-sm shadow-sm focus:border-black focus:ring-black" onchange="this.form.submit()">
                <option value="newest" selected={sort === 'newest'}>Newest</option>
                <option value="price-asc" selected={sort === 'price-asc'}>Price: Low to High</option>
                <option value="price-desc" selected={sort === 'price-desc'}>Price: High to Low</option>
                <option value="name-asc" selected={sort === 'name-asc'}>Name: A-Z</option>
                <option value="name-desc" selected={sort === 'name-desc'}>Name: Z-A</option>
             </select>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-4 mx-4 flex md:hidden flex-wrap gap-x-2 gap-y-2">
    <a href={hrefWith({ cat: null })} class:list={['block text-sm transition border rounded-2xl p-2', { 'font-bold text-white bg-black': !catParam }, { 'text-gray-600 hover:text-white hover:bg-gray-500': !!catParam } ]}>All Products</a>
    {allCategories.map(c => {
      let customHref = hrefWith({ cat: c.slug });
      return (<a href={customHref} class:list={['block text-sm transition border rounded-2xl p-2', { 'font-bold  text-white bg-black border-lg border-white': catParam === c.slug }, { 'text-gray-600 hover:text-white hover:bg-gray-500': catParam !== c.slug }]}>{c.title}</a>)
    })}
  </div>

  <div class="mx-auto max-w- px-4 py-4 sm:px-4 lg:px-8">
    <div class="grid grid-cols-1 gap-x-8 gap-y-10 lg:grid-cols-4">
      <FilterSidebar 
        allCategories={allCategories}
        catParam={catParam}
        minPrice={minPrice}
        maxPrice={maxPrice}
        minVal={minVal}
        maxVal={maxVal}
        instockOnly={instockOnly}
        sort={sort}
        hrefWith={hrefWith}
      />

      <section class="lg:col-span-3">
        {pageItems.length === 0 ? (
          <div class="flex h-96 items-center justify-center rounded-lg border-2 border-dashed bg-gray-50">
            <div class="text-center">
              <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
              <h3 class="mt-2 text-sm font-semibold text-gray-900">No products found</h3>
              <p class="mt-1 text-sm text-gray-500">Try adjusting your filters or clearing them to see all products.</p>
              <div class="mt-6">
                <a href="/products" class="inline-flex items-center rounded-md bg-black px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-800">
                  Clear all filters
                </a>
              </div>
            </div>
          </div>
        ) : (
          <>
            <div class="grid grid-cols-2 gap-x-4 gap-y-8 sm:grid-cols-2 md:grid-cols-4 lg:gap-x-6">
              {pageItems.map((p: any) => (<ShopProductCard product={p} />))}
            </div>

            <nav class="mt-12 flex items-center justify-center gap-x-2">
              <a href={page > 1 ? pageHref(page - 1) : '#'} class:list={['inline-flex h-10 w-10 items-center justify-center rounded-lg border', { 'text-gray-400 pointer-events-none bg-gray-50': page <= 1 }, { 'bg-white hover:bg-gray-100': page > 1 }]}>&larr;</a>
              {Array.from({ length: totalPages }).map((_, i) => {
                const n = i + 1;
                return <a href={pageHref(n)} class:list={['inline-flex h-10 w-10 items-center justify-center rounded-lg border text-sm font-medium', { 'bg-black text-white': n === page }, { 'bg-white hover:bg-gray-100': n !== page }]}>{n}</a>;
              })}
              <a href={page < totalPages ? pageHref(page + 1) : '#'} class:list={['inline-flex h-10 w-10 items-center justify-center rounded-lg border', { 'text-gray-400 pointer-events-none bg-gray-50': page >= totalPages }, { 'bg-white hover:bg-gray-100': page < totalPages }]}>&rarr;</a>
            </nav>
          </>
        )}
      </section>
    </div>
  </div>
</BaseLayout>
